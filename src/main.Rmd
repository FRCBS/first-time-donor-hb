---
title: "hb trends"
author: "Timo Asikainen"
date: "2025-02-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
load('C:/git_repot/DATA/donationdata.fortimo.rdata')
```

```{r}
library(dplyr)
library(lubridate)
library(tidyr)
```


```{r load-and-process-data}
simple = donationdata$donation
wh = which(simple$Hb==50)
simple[wh,]

str(simple)

simple = left_join(simple,donationdata$donor[,c('releaseID','DateOfBirth','Sex','BloodGroup')],by='releaseID')
simple$age= as.numeric(difftime(simple$DonationDate,simple$DateOfBirth),unit="weeks")/52.25
simple$month = as.factor(month(simple$DonationDate))
simple$year = year(simple$DonationDate)
simple$year.factor = as.factor(simple$year)

date0 = simple %>%
  group_by(releaseID) %>%
  summarise(date0=min(DonationDate),.groups='drop')

donation0 = simple %>%
  inner_join(date0,join_by(x$DonationDate==y$date0,releaseID))

# repeat donations
donation.r = simple %>%
  left_join(cbind(date0,sent=1),join_by(x$DonationDate==y$date0,releaseID)) %>%
  filter(is.na(sent)) %>%
  select(-sent)

# mr=lm(Hb~0+month,data=donation.r)
# summary(mr) # Nämä olisi varmaankin saanut myös suoraan keskiarvoina

seasonal = donation.r %>%
  group_by(month) %>%
  summarise(seasonal=mean(Hb,na.rm=TRUE),.groups='drop')

# repeat donations (?)
donation.r = inner_join(donation.r,seasonal,join_by(month))

# donation0$year=year(donation0$DonationDate)
# donation0$year.factor=as.factor(donation0$year)
```

```{r function-definitions}

plotYearSex = function(m,relative=FALSE) {
  cofs = summary(m)$coeff
  conames=rownames(cofs)
  codf=data.frame(name=conames,estimate=cofs[,1])
  wh=grep('(Male|Female)',conames)
  codf$Sex[wh]=sub('.*(Male|Female).*','\\1',conames[wh])
  wh=grep('[0-9][0-9][0-9][0-9]',conames)
  codf$year[wh]=sub('[^0-9]+([0-9]+).*','\\1',conames[wh])
  codf=cbind(codf,confint(m))
  
  codf=codf[!is.na(codf$year),]
  pah=pivot_wider(codf,names_from='year',values_from='estimate',id_cols=c('Sex'))
  rn = as.vector(pah[,1])
  pah=as.data.frame(pah[,-1])
  rownames(pah)=rn$Sex
  
  means=apply(pah,1,mean)
  if (!relative)
    means=0*means
  
  pah=pah-means
  
  pah2=pivot_wider(codf,names_from='year',values_from='2.5 %',id_cols=c('Sex'))
  pah2=as.data.frame(pah2[,-1])
  pah2=pah2-means
  pah3=pivot_wider(codf,names_from='year',values_from='97.5 %',id_cols=c('Sex'))
  pah3=as.data.frame(pah3[,-1])
  pah3=pah3-means
  
  pah.all=rbind(pah,pah2,pah3)
  
  matplot(t(pah.all),type='l',lty=c(rep('solid',2),rep('dashed',4)),col=rep(c('red','blue'),2),axes=FALSE)
  axis(2)
  axis(side=1,at=1:ncol(pah.all),labels=colnames(pah.all))
  return(pah.all)
}
```

```{r}
m=lm(0+Hb~age+Sex+seasonal+year.factor:Sex,data=donation.r[donation.r$year>=2005,])
sm=summary(m)
r.mat=plotYearSex(m)
str(r.mat)
adjustment=pivot_longer(cbind(Sex=rownames(r.mat)[1:2],r.mat[1:2,]),colnames(r.mat),names_to='year') # ,names_to='Sex',values_to='value')
adjustment$year=as.integer(adjustment$year)

str(seasonal)
seasonal$month=as.integer(seasonal$month)
str(adjustment)
str(donation0)
```


```{r}
# compute the adjusted data for first-time donations (?):
# substract the unexplained effect (year x sex) estimated from 
donation0a = donation0 %>%
  inner_join(seasonal,join_by(month)) %>%
  inner_join(adjustment,join_by(Sex,year)) %>%
  mutate(Hb.adj = Hb - value)

donation0a$month.factor=as.factor(donation0a$month)

summary(donation0a)

# adjusted model
m=lm(Hb.adj~0+Sex+age+year.factor:Sex+seasonal,data=donation0a[donation0a$year>=2005,])
sm=summary(m)
sm
final=plotYearSex(m,relative=TRUE)
estimateTrend(final)
apply(final,1,min)
apply(final,1,max)

# plot(m) 

# m=lm(Hb~0+year.factor:Sex+seasonal,data=donation0a[donation0a$year>=2005,])
# final=plotYearSex(m,relative=TRUE)
# estimateTrend(final)

# unadjusted data
m=lm(Hb~0+age+Sex+year.factor:Sex,data=donation0[donation0$year>=2005,])
summary(m)
final=plotYearSex(m,relative=TRUE)
estimateTrend(final)

estimateTrend = function(final) {
  final.longer = matToLonger(final)
  final.longer$interceptFemale=1
  final.longer$interceptFemale[final.longer$Sex=='Male']=0
  final.longer$interceptMale=1-final.longer$interceptFemale
  m=lm(value~0+interceptFemale+interceptMale+year:Sex,data=final.longer)
  print(summary(m))
  return(m)
}

matToLonger = function(mat) {
  df1=as.data.frame(pivot_longer(cbind(Sex=rownames(mat)[1:2],mat[1:2,]),colnames(mat),names_to='year'))
  df1$year=as.integer(df1$year)
  return(df1)
}
```


```{r}
# annual = cbind(t(r.mat["Male",]),t(r.mat["Female",]))

donation0$year=year(donation0$DonationDate)

# donation0$year.factor = as.factor(donation0$year)
str(donation0$year.factor)

# Regressiomalleja

m=lm(Hb~age+Sex+year,data=donation0)
summary(m)

m=lm(0+Hb~age+Sex+Sex:year,data=donation0)
summary(m)

m=lm(0+Hb~age+Sex+year.factor:Sex,data=donation0[donation0$year>=2005,])
# m=lm(0+Hb~age+year.factor:Sex,data=donation0)
summary(m)
sm=summary(m)
# plot(sm$coeff[4:nrow(sm$co),1])

cofs
m=lm(Hb~year,data=donation0)
summary(m)
```

```{r}
data=donation0[donation0$year>=2005&donation0$Sex=='Male',c('Hb')]
str(data)
data=c(data)
str(data)
hist(data$Hb)
```

```{r}
# Jakaumia
dist = donation0 %>%
  filter(!is.na(Hb)) %>%
  mutate(Hb=pmin(pmax(Hb,100),200)) %>%
  group_by(year,Sex,Hb) %>%
  summarise(n=n(),.groups='drop')

dist$Hb=as.integer(dist$Hb)
dist$year=as.integer(dist$year)
dist.male = as.data.frame(dist[dist$Sex=='Male',!colnames(dist) %in% c('Sex')])
tab.male = as.data.frame(pivot_wider(dist.male,names_from='Hb',values_from='n',values_fill=0,names_sort=TRUE))
rownames(tab.male)=tab.male$year
tab.male=tab.male[,-1]
tab.male
row.sums = apply(tab.male,1,sum,na.rm=TRUE)
prop.male = tab.male / row.sums
# prop.male[is.na(prop.male)] = 0
cuml.male = apply(prop.male,1,cumsum)
dim(cuml.male)
cuml.male[,1]

tab.male[1:5,1:5]
i=0
dim(cuml.male)
for (i in 0:4) {
  matplot(cuml.male[1:40,5*i+(1:5)],type='l',ylim=c(0,0.1),main=paste(5*i+(1:5),collapse=' '))
}
lines(1:ncol(cuml.male),cuml.male['135',])

colnames(cuml.male)
cuml.male['135',]



matplot(cuml.male[1:40,5*i+(1:5)],type='l',ylim=c(0,0.2))
```

```{r normal-distribution-parameter-testing}
avg=150
stdev=8
pnorm(135,mean=avg,sd=stdev)

diff=seq(-5,2,0.1)
y=pnorm(135+diff,mean=avg,sd=stdev)
wh0=which(diff==0) 
y=y/y[wh0]
plot(y~diff,xlab='difference in mean',ylab=paste0('ratio between mean+diff and mean=',avg))
abline(v=0,lty='dashed')

diff=seq(-1,3,0.05)
y=pnorm(135,mean=avg,sd=stdev+diff)
wh0=which(diff==0)
y=y/y[wh0]
plot(y~diff,xlab='difference in stdev',ylab=paste0('ratio between stdev+diff and stdev=',stdev))
abline(v=0,lty='dashed')
# Riippuvuus ei ole lineaarinen
# abline(a=y[wh0],b=(y[length(y)]-y[1])/(diff[length(diff)]-diff[1]))
```
